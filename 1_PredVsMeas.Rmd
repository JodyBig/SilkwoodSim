---
title: "Sim vs Obs for Bronwyn Masters' Silkwood experiment on a Bulgun soil"
author: "Jody Biggs"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    fig_caption: yes
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(stringr)
library(tidyverse)
library(ggthemes)
library(knitr)
library(ReporteRs)
library(ReporteRsjars)
library(hydroGOF)
library(broom)
```

# Experiment details

## Site

- Silkwood, South Johnstone sub-basin
- (17^o^44'44.72"S; 146^o^2'58.76"E)
- Bingal Bay BOM station #032009

## Treatments

- Urea unless otherwise indicated
- Unreplicated

```{r}
treatDesc <-
  read.csv('./Measurements/TreatmentDescription.csv', stringsAsFactors = FALSE) %>%
  mutate(ratoon_no = as.character(ratoon_no))
kable(treatDesc)
```

## Measurements

- Above-ground biomass was measured but the values are not in the report
- Water quality data collected from T1-T4 only

### N loss

- Total off-site N loss ranged from 19-112 kgN/ha
- Plant crop NinRO = 6-11 kgN/ha
- Ratoon crop NinRO = 8-12 kgN/ha
- Plant crop runoff 8% of rainfall
- Ratoon crop runoff 48% of rainfall
- Plant crop drainage 31% of rainfall
- Ratoon crop drainage 22% of rainfall
- Unaccounted for N was considered to be primarily gas loss (via denit and volat)


## Crop management

- Q183 variety
- 2014-05-28: Preliminary nutrients soil sampling
- 2014-07-21: Nutrients soil sampling (prior to planting)
- 2014-07-21: planted 2014-07-21
- 2014-07-21: at planting DAP 22.5 kgN/ha + 7 kgN/ha in liquid form
- 2014-10-22: N fertiliser top-dressed and lightly cultivated (3month later; check date is not 2014-10-02)
- 2015-11-11: harvest (gctb); soil sampling to 90cm	
- 2015-11-25: N fertiliser applied via stool-split
- 2016-??-??: ratoon crop harvest
- 2016-11-28: soil sampling to 90cm (after harvest)
	
- T1 plant crop impacted by lodging and subsequent suckering (image taken 2015-03-08)
- Two metre spaced beds with dual cane rows 70cm apart
- Cultivation and weed mgt same across treatments
	
## Paddock history:

- previous sugarcane yields at the paddock were 35-72 t/ha
- laser-leveled in 2013 (following harvest)
- sprayed out bare fallow for 2013-2014 season
- further cultivation after wet season

## Soil:

- Hydrosol / Bulgun soil
- Hydrosol is a soil that experiences saturation of the greater part of the profile for prolonged periods in most years.
- low permeability
- low elevation
- high propotion of runoff
- saturated for long periods of time
- water table remaining within 60cm for days to weeks after substantial rainfall
	
## Climate:

- Rainfall:
    + Below average rainfall for 2014-2016
    + Plant crop = 1718 mm (average 3075mm)
    + Ratoon crop = 2498 mm
    

```{r}
## Read in apsim output files ----
apsimFiles <- list.files(path=".", pattern="*harvest.out", recursive=TRUE, full.names=TRUE)

readIn <- function(fileName){
  temp <- read.table(fileName, header=TRUE, skip=2, nrows=6)
  columnNames <- colnames(temp)
  temp <- read.table(fileName, header=FALSE, skip=4, na.strings = "?")
  colnames(temp) <- columnNames
  temp$treatCode = str_sub(fileName,3,4)
  return(temp)
}

sim <- do.call("rbind", lapply(apsimFiles, FUN=readIn))

sim <-
  sim %>%
  tbl_df() %>%
  mutate(treatValue = str_sub(treatCode, 2,2)) %>%
  mutate(cropClass = case_when(
    ratoon_no == 0 ~ 'Plant',
    ratoon_no == 1 ~ 'Ratoon1'
  )) %>%
  # mutate(cropClass = factor(cropClass, levels=c('Plant', '1st Ratoon'))) %>%
  mutate(yield_t_ha = cane_wt/100/0.3) %>% # convert from g/m2 dry cane to t/ha wet cane with an assumed dmf of 0.3
  mutate(biomass_t_ha = biomass/100) %>% # convert from g/m2 to t/ha
  mutate(biomassN_kg_ha = biomass_n*10) %>% # convert from g/m2 to kg/ha
  select(-cane_wt, -biomass, -biomass_n)
```

# Plot average stress indices

```{r}
#### Plot average stress indices ----
sim %>%
  select(treatCode, treatValue, ratoon_no, cropClass, avgNstress, avgWaterstress, avgOXDEFstress) %>%
  gather(variable, value, avgNstress, avgWaterstress, avgOXDEFstress) %>%
  ggplot(aes(as.numeric(treatValue), value, colour=variable))+
  geom_line(size=1)+
  geom_point()+
  scale_colour_gdocs()+
  facet_wrap(~cropClass)+
  theme_few()+
  theme(legend.title = element_blank())
```

# Plot a partial N balance

```{r}
initialTotN = head(sim$nit_tot..,1)

#### Plot a partial N balance ---
tmp <-
  sim %>%
  mutate(nit_totDiff = c(NA,diff(nit_tot..))) %>%
  # mutate(nit_totDiff = ifelse(ratoon_no == 0, NA, nit_totDiff)) %>%
  select(treatCode, treatValue, ratoon_no, cropClass, sumDenit, sumNinDD, sumNinRO, biomassN_kg_ha, nit_totDiff) %>%
  gather(variable, value, sumDenit, sumNinDD, sumNinRO, biomassN_kg_ha, nit_totDiff) %>%
  # mutate(variable = factor(variable, levels = c('sumDenit', 'sumNinDD', 'sumNinRO', 'biomassN_kg_ha', 'nit_totDiff'), labels = c('N denitrified', 'N in deep drainage', 'N in runoff', 'N in above ground biomass', 'Change in soil N'))) %>%
  mutate(treatValue = as.numeric(treatValue))

tmp1 <- tmp %>% filter(value >= 0)
tmp2 <- tmp %>% filter(value < 0)

ggplot()+
  geom_col(data=tmp1, aes(treatValue, value, fill = variable))+
  geom_col(data=tmp2, aes(treatValue, value, fill=variable))+
  geom_hline(yintercept=0)+
  scale_fill_colorblind()+
  facet_wrap(~cropClass)+
  theme_few()
```

# Plot a partial water balance

```{r}
#### Plot a partial water balance ----
sim %>%
  select(treatCode, treatValue, ratoon_no, cropClass, sumDrain, sumRunoff, sumRain, sumES, sumEP) %>%
  gather(variable, value, sumDrain, sumRunoff, sumRain, sumES, sumEP) %>%
  ggplot(aes(as.numeric(treatValue), value, colour=variable))+
  geom_line()+
  geom_point()+
  facet_wrap(~cropClass)+
  scale_colour_gdocs()+
  xlab('Fertiliser N Treatment (kgN/ha)')+
  ylab('(mm)')+
  theme_few()
```

```{r}
#### Read in measured data ----
#### Cane yields ----
obs <-
  tbl_df(read.csv('./Measurements/CaneYield.csv', header=TRUE, stringsAsFactors = FALSE)) %>%
  mutate(treatValue = str_sub(treatCode, 2,2)) %>%
  gather(variable, value, CCS_perc, TCH_t_ha, DM_t_ha) %>%
  mutate(ratoon_no = case_when(
    cropClass == 'Plant' ~ '0',
    TRUE ~ str_extract(cropClass,'[0-9]'))
  )

sim1 <-
  sim %>%
  select(treatCode, treatValue, ratoon_no, cropClass, yield_t_ha, biomass_t_ha) %>%
  mutate(ratoon_no = as.character(ratoon_no)) %>%
  mutate(cropClass = as.character(cropClass)) %>%
  mutate(dataSource = 'simulated') %>%
  gather(variable, value, yield_t_ha, biomass_t_ha)

obs1 <-
  obs %>%
  filter(variable %in% c("TCH_t_ha","DM_t_ha")) %>%
  mutate(variable = case_when(
    variable == "TCH_t_ha" ~ 'yield_t_ha',
    variable == "DM_t_ha" ~ 'biomass_t_ha'
    )) %>%
  mutate(dataSource = 'measured') %>%
  select(treatCode, treatValue, ratoon_no, cropClass, dataSource, variable, value)

d <-
  obs1 %>%
  bind_rows(sim1)
```

# Simulated vs Observed

## Mean cane yield and biomass

```{r}
#### Compare mean yield and biomass using actual yields ----
d %>%
  mutate(variable = factor(variable, levels=c('yield_t_ha', 'biomass_t_ha'), labels = c('Cane yield (t/ha)', 'Dry plant biomass(t/ha)'))) %>%
  na.omit() %>%
  ggplot(aes(as.numeric(treatValue), value, colour=dataSource))+
  geom_point()+
  facet_grid(variable~cropClass, scale='free_y', switch='y')+
  xlab('Fertiliser N Treatment (kgN/ha)')+
  scale_colour_colorblind()+
  theme_few()+
  theme(axis.title.y = element_blank())
```

## Determine the N rate/s where 95% of yield at maximum N was achieved

```{r}
#### Determine the N rate/s where 95% of yield at maximum N was achieved ----

d1 <-
  d %>%
  filter(variable == 'yield_t_ha') %>%
  group_by(dataSource, ratoon_no, treatCode, variable) %>%
  summarise(meanYld = mean(value))

n240Values <-
  d1 %>%
  filter(treatCode == 'T1') %>%
  mutate(AtMaxN = meanYld) %>%
  ungroup() %>%
  select(-treatCode, -meanYld)

d1 <-
  d1 %>%
  left_join(n240Values, by = c("dataSource", "ratoon_no", "variable")) %>%
  mutate(percOfMaxN = meanYld/AtMaxN * 100)

```

# Regression summary


```{r}
regrD  <-
  d %>%
  group_by(dataSource, treatCode, ratoon_no, cropClass, variable) %>%
  summarise(value = mean(value)) %>%
  spread(dataSource, value) %>%
  na.omit()

regrD_nested <-
  regrD %>%
  ungroup() %>%
  select(variable, measured, simulated) %>%
  nest(-variable)

fitLM <- function(x){lm(simulated ~ measured, data=x)}
gofd <- function(x){
  tmp <- gof(sim=x$simulated, obs=x$measured)
  data.frame(gofTest=row.names(tmp), tmp)
  }

model_nested <-
  regrD_nested %>%
  mutate(fit = map(data, fitLM)) %>%
  mutate(gof = map(data, gofd))

funcParam <-
  model_nested %>%
  rowwise() %>%
  do(params = glance(.$fit),
     formula = tidy(.$fit))

funcParam <-
  model_nested %>%
  bind_cols(funcParam)

```



```{r}

kable(
  funcParam %>%
    unnest(formula)
)

gofVariables <-
  model_nested %>%
  select(variable, gof) %>%
  unnest() %>%
  spread(variable, tmp)

kable(gofVariables)



```


## Yield

```{r warning=FALSE}
grfResponse <- function(varName){
  regrD %>%
    filter(variable == varName) %>%
    filter(treatCode != 'T4') %>%
    gather(dataSource, value, measured, simulated) %>%
    left_join(treatDesc, by = c("treatCode", "ratoon_no")) %>%
    ggplot(aes(fertN_kg_ha, value, colour=dataSource))+
    geom_point()+
    geom_smooth(se=FALSE)+
    facet_wrap(~cropClass)+
    scale_colour_gdocs()+
    theme_few()
}

grfResponse('yield_t_ha')

grfXY <- function(varName){
  regrD %>%
    filter(variable == varName) %>%
    left_join(treatDesc, by = c("treatCode", "ratoon_no")) %>%
    ggplot(aes(measured, simulated))+
    geom_point(aes(colour=cropClass))+
    geom_smooth(method='lm', se=FALSE)+
    geom_abline()+
    scale_colour_gdocs()+
    theme_few()
}
grfXY('yield_t_ha')
```

